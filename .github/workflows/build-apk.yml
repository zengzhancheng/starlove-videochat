name: Build APK for 星恋

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Setup Expo CLI
      run: npm install -g @expo/cli@latest

    - name: Setup EAS CLI
      run: npm install -g @expo/eas-cli@latest

    - name: Login to Expo
      run: eas login --non-interactive
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    - name: Build APK (云端构建)
      run: eas build --platform android --non-interactive
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    - name: Wait for build completion
      run: |
        echo "等待构建完成..."
        sleep 300  # 等待5分钟让构建开始
        
        # 获取最新的构建
        BUILD_ID=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].id')
        echo "构建ID: $BUILD_ID"
        
        # 等待构建完成
        while true; do
          STATUS=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].status')
          echo "构建状态: $STATUS"
          
          if [ "$STATUS" = "finished" ]; then
            echo "构建完成！"
            break
          elif [ "$STATUS" = "errored" ]; then
            echo "构建失败！"
            exit 1
          fi
          
          sleep 60  # 等待1分钟
        done
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    - name: Download APK
      run: |
        BUILD_ID=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].id')
        eas build:download $BUILD_ID
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: starlove-apk
        path: "*.apk"
        retention-days: 30
