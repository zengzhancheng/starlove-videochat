name: ğŸš€ Build FanYouApp APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm install
      
    - name: ğŸ”§ Setup Expo
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        token: ${{ secrets.EXPO_TOKEN }}
        
    - name: ğŸ—ï¸ Build APK with EAS
      run: |
        eas build --platform android --profile preview --non-interactive --wait
        
    - name: ğŸ“± Download APK
      run: |
        # è·å–æœ€æ–°çš„æ„å»º
        BUILD_ID=$(eas build:list --platform android --limit 1 --json | jq -r '.[0].id')
        echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
        
        # ä¸‹è½½APK
        eas build:download $BUILD_ID --output ./FanYouApp.apk
        
    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: FanYouApp-APK
        path: FanYouApp.apk
        retention-days: 30
        
    - name: ğŸ“Š Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        files: FanYouApp.apk
        tag_name: v${{ github.run_number }}
        name: FanYouApp v${{ github.run_number }}
        body: |
          ğŸ‰ FanYouApp APK è‡ªåŠ¨æ„å»ºå®Œæˆï¼
          
          ğŸ“± **ç‰ˆæœ¬**: v${{ github.run_number }}
          ğŸ“… **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
          ğŸ”„ **æäº¤**: ${{ github.sha }}
          
          ## ğŸ“¥ ä¸‹è½½APK
          ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½æŒ‰é’®è·å–APKæ–‡ä»¶
          
          ## ğŸ“‹ å®‰è£…è¯´æ˜
          1. ä¸‹è½½APKæ–‡ä»¶åˆ°æ‰‹æœº
          2. å¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. æˆäºˆå¿…è¦æƒé™
          4. å¼€å§‹ä½¿ç”¨é¥­å‹APP
          
          ## ğŸ”§ åŠŸèƒ½ç‰¹æ€§
          - âœ… ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
          - âœ… åœ°ç†ä½ç½®åŒ¹é…
          - âœ… å®æ—¶èŠå¤©
          - âœ… è§†é¢‘é€šè¯
          - âœ… æ¨é€é€šçŸ¥
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ios:
    runs-on: macos-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm install
      
    - name: ğŸ”§ Setup Expo
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        token: ${{ secrets.EXPO_TOKEN }}
        
    - name: ğŸ—ï¸ Build iOS with EAS
      run: |
        eas build --platform ios --profile preview --non-interactive --wait
        
    - name: ğŸ“± Download iOS build
      run: |
        # è·å–æœ€æ–°çš„iOSæ„å»º
        BUILD_ID=$(eas build:list --platform ios --limit 1 --json | jq -r '.[0].id')
        echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
        
        # ä¸‹è½½IPA
        eas build:download $BUILD_ID --output ./FanYouApp.ipa
        
    - name: ğŸ“¤ Upload iOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: FanYouApp-iOS
        path: FanYouApp.ipa
        retention-days: 30

  notify:
    runs-on: ubuntu-latest
    needs: [build-apk]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify build status
      run: |
        if [ "${{ needs.build-apk.result }}" == "success" ]; then
          echo "âœ… APKæ„å»ºæˆåŠŸï¼"
          echo "ğŸ“± å¯ä»¥åœ¨Releaseé¡µé¢ä¸‹è½½APKæ–‡ä»¶"
        else
          echo "âŒ APKæ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"
        fi

